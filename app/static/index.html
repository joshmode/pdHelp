<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pdHelp by joshmode</title>
    <style>
        :root {
            color-scheme: light;
            --bg: #f6f7fb;
            --panel: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --line: #e5e7eb;
            --assistant-bg: #eff6ff;
            --user-bg: #ecfeff;
            --error-bg: #fef2f2;
            --error-text: #b91c1c;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .app {
            width: min(960px, 100%);
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: 0 12px 35px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        .header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--line);
        }

        .header h1 {
            margin: 0;
            font-size: 1.35rem;
        }

        .header p {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .top-controls {
            display: grid;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--line);
        }

        @media (min-width: 820px) {
            .top-controls {
                grid-template-columns: 1fr auto;
                align-items: center;
            }
        }

        .file-control {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        input[type="file"] {
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 8px;
            background: #fff;
        }

        button {
            border: none;
            border-radius: 10px;
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            padding: 10px 14px;
            transition: background 0.18s ease;
        }

        button:hover { background: var(--primary-dark); }
        button:disabled { opacity: 0.65; cursor: not-allowed; }

        #upload-status {
            color: var(--muted);
            font-size: 0.9rem;
            min-height: 1.2em;
        }

        #upload-status.error {
            color: var(--error-text);
            background: var(--error-bg);
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 8px;
        }

        #chat-history {
            min-height: 300px;
            max-height: 50vh;
            overflow-y: auto;
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fcfcff;
        }

        .empty {
            color: var(--muted);
            text-align: center;
            margin: 18px 0;
        }

        .bubble {
            border-radius: 12px;
            padding: 12px 14px;
            line-height: 1.45;
            border: 1px solid var(--line);
            white-space: pre-wrap;
        }

        .bubble.user {
            background: var(--user-bg);
            align-self: flex-end;
            max-width: 75%;
        }

        .bubble.assistant {
            background: var(--assistant-bg);
            align-self: flex-start;
            max-width: 85%;
        }

        .composer {
            padding: 16px 24px 22px;
            border-top: 1px solid var(--line);
            display: grid;
            gap: 8px;
        }

        textarea {
            width: 100%;
            min-height: 84px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px 12px;
            font: inherit;
            resize: vertical;
        }

        .composer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        #answer-box {
            color: var(--muted);
            font-size: 0.9rem;
            min-height: 1.2em;
        }
    </style>
</head>
<body>
    <main class="app">
        <header class="header">
            <h1>pdHelp</h1>
            <p>Upload a PDF, ask questions, and review your Q&A history like it's ChatGPT! Follow @joshmode on GitHub for more</p>
        </header>

        <section class="top-controls">
            <div class="file-control">
                <input type="file" id="pdf-file" accept=".pdf,application/pdf" />
                <button id="upload-btn" type="button">Upload PDF</button>
            </div>
            <div id="upload-status">No PDF uploaded yet.</div>
        </section>

        <section id="chat-history" aria-live="polite">
            <p class="empty" id="empty-history">Your previous questions and answers will appear here.</p>
        </section>

        <section class="composer">
            <label for="question-text">Query</label>
            <textarea id="question-text" placeholder="Ask a question about the uploaded PDF..."></textarea>
            <div class="composer-footer">
                <div id="answer-box">Answer box: ask a question to see the latest answer.</div>
                <button id="ask-btn" type="button">Ask</button>
            </div>
        </section>
    </main>

    <script>
        const state = {
            currentQuestion: "",
            currentAnswer: ""
        };

        const fileInput = document.getElementById("pdf-file");
        const uploadBtn = document.getElementById("upload-btn");
        const askBtn = document.getElementById("ask-btn");
        const uploadStatus = document.getElementById("upload-status");
        const questionInput = document.getElementById("question-text");
        const history = document.getElementById("chat-history");
        const emptyHistory = document.getElementById("empty-history");
        const answerBox = document.getElementById("answer-box");

        function appendBubble(text, type) {
            const bubble = document.createElement("div");
            bubble.className = `bubble ${type}`;
            bubble.textContent = text;
            history.appendChild(bubble);
            history.scrollTop = history.scrollHeight;
        }

        function moveCurrentToHistory() {
            if (!state.currentQuestion || !state.currentAnswer) return;
            if (emptyHistory) {
                emptyHistory.remove();
            }
            appendBubble(state.currentQuestion, "user");
            appendBubble(state.currentAnswer, "assistant");
        }

        function setUploadStatus(message, isError = false) {
            uploadStatus.textContent = message;
            uploadStatus.classList.toggle("error", isError);
        }

        uploadBtn.addEventListener("click", async () => {
            const file = fileInput.files?.[0];
            if (!file) {
                setUploadStatus("Please choose a PDF file before uploading.", true);
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            uploadBtn.disabled = true;
            setUploadStatus("Uploading and indexing your PDF...");

            try {
                const response = await fetch("/upload", { method: "POST", body: formData });
                const body = await response.json();
                if (!response.ok) {
                    throw new Error(body.detail || "Upload failed.");
                }
                setUploadStatus(`Uploaded: ${body.filename}. You can start asking questions.`);
            } catch (error) {
                setUploadStatus(error.message, true);
            } finally {
                uploadBtn.disabled = false;
            }
        });

        askBtn.addEventListener("click", async () => {
            const question = questionInput.value.trim();
            if (!question) {
                answerBox.textContent = "Please enter a question first.";
                return;
            }

            moveCurrentToHistory();
            state.currentQuestion = question;
            state.currentAnswer = "";

            askBtn.disabled = true;
            answerBox.textContent = "Thinking...";

            try {
                const response = await fetch("/query", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: question })
                });

                const body = await response.json();
                if (!response.ok) {
                    throw new Error(body.detail || "Failed to get an answer.");
                }

                state.currentAnswer = body.reply;
                answerBox.textContent = body.reply;
                questionInput.value = "";
            } catch (error) {
                state.currentQuestion = "";
                state.currentAnswer = "";
                answerBox.textContent = `Error: ${error.message}`;
            } finally {
                askBtn.disabled = false;
            }
        });

        questionInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
                askBtn.click();
            }
        });
    </script>
</body>
</html>
